---
import { Image } from 'astro:assets';
import { formatDate } from '../../ts/utils';
import './UserCard.scss';

type UserRow = Record<string, any>;

interface Props {
  user: UserRow;
  lang?: 'hu' | 'en';
}

const { user, lang = 'hu' } = Astro.props;
const avatarPath = typeof user?.avatar_url === 'string' && user.avatar_url.startsWith('/') ? user.avatar_url : null;
const fullName = `${user?.family_name ?? ''} ${user?.first_name ?? ''}`.trim();
const isMonthly = user?.pass_type === 'monthly';
const statusText = isMonthly ? 'ACTIVE' : 'LIMITED';

// Role fordítás
const roleTranslations: Record<string, string> = {
  practitioner: 'GYAKORLÓ',
  admin: 'ADMINISZTRÁTOR',
};

const translatedRole = user?.role ? roleTranslations[user.role.toLowerCase()] || user.role.toUpperCase() : null;
---

<section class="user-card" aria-label="User profile" data-user-card>
  <div class="user-card__profile-section">
    {
      avatarPath && (
        <div class="user-card__avatar-container">
          <Image
            src={avatarPath}
            alt={fullName || 'User avatar'}
            width={140}
            height={140}
            class="user-card__avatar"
            loading="lazy"
            decoding="async"
          />
        </div>
      )
    }

    <div class="user-card__profile-info">
      <div class="user-card__label">‹ NÉV :</div>
      <h2 class="user-card__name">{fullName || 'User'}</h2>
      {translatedRole && <div class="user-card__role">| {translatedRole} |</div>}
    </div>

    <div class="user-card__status">
      <span class="user-card__status-dot"></span>
      <span class="user-card__status-text">{statusText}</span>
    </div>
  </div>

  <div class="user-card__info-grid">
    {
      user?.birthday && (
        <div class="user-card__info-row">
          <span class="user-card__info-label">‹ SZÜLETÉSI DÁTUM :</span>
          <span class="user-card__info-value">{formatDate(user.birthday, lang)}</span>
        </div>
      )
    }

    {
      user?.phone_number && (
        <div class="user-card__info-row">
          <span class="user-card__info-label">‹ TELEFON :</span>
          <span class="user-card__info-value">{user.phone_number}</span>
        </div>
      )
    }

    {
      user?.email && (
        <div class="user-card__info-row">
          <span class="user-card__info-label">‹ EMAIL :</span>
          <span class="user-card__info-value">{user.email}</span>
        </div>
      )
    }
  </div>

  {
    user?.last_asana && (
      <div class="user-card__asana-section">
        <div class="user-card__asana-label">‹ UTOLSÓ ÁSZANÁD :</div>
        <div class="user-card__asana-text">{user.last_asana}</div>
      </div>
    )
  }

  <div class="user-card__access-section">
    <div class="user-card__access-title">• ACCESS STATUS •</div>

    {
      isMonthly ? (
        <div class="user-card__access-body">
          <div class="user-card__info-row">
            <span class="user-card__info-label">‹ BÉRLET:</span>
            <span class="user-card__info-value">HAVI</span>
          </div>

          {user?.assigned_at && (
            <div class="user-card__info-row">
              <span class="user-card__info-label">‹ VÁSÁRLÁS:</span>
              <span class="user-card__info-value">{formatDate(user.assigned_at, lang)}</span>
            </div>
          )}

          {user?.expires_at && (
            <div class="user-card__info-row">
              <span class="user-card__info-label">‹ ÉRVÉNYES:</span>
              <span class="user-card__info-value">{formatDate(user.expires_at, lang)}</span>
            </div>
          )}
        </div>
      ) : (
        <div class="user-card__access-body">
          <p class="user-card__muted">Nincs aktív havi bérlet.</p>
        </div>
      )
    }
  </div>

  <div class="user-card__actions">
    <button class="user-card__logout" type="button" data-logout>KILÉPÉS</button>
  </div>

  <script>
    import { actions } from 'astro:actions';
    import { navigate } from 'astro:transitions/client';

    function initUserCard() {
      const root = document.querySelector('[data-user-card]');
      console.log('UserCard root:', root);

      if (!root) {
        console.log('Root not found!');
        return;
      }

      const logoutButton = root.querySelector('[data-logout]') as HTMLButtonElement;

      logoutButton?.addEventListener('click', async () => {
        logoutButton.textContent = 'KILÉPÉS...';
        logoutButton.style.background = 'rgba(212, 175, 55, 0.3)';

        const { error } = await actions.logout(new FormData());

        if (!error) {
          navigate('/login');
        } else {
          logoutButton.textContent = 'KILÉPÉS';
          logoutButton.style.background = 'transparent';
        }
      });

      // Scanline effect
      const existingScanline = root.querySelector('.user-card__scanline');
      if (!existingScanline) {
        console.log('Creating scanline...');

        // Hozzáadjuk a keyframes-t, ha még nincs
        if (!document.getElementById('scanline-keyframes')) {
          const style = document.createElement('style');
          style.id = 'scanline-keyframes';
          style.textContent = `
            @keyframes scanline-anim {
              0% {
                transform: translateY(-3px) translateX(0);
                opacity: 0;
              }
              1% { transform: translateY(0vh) translateX(-1px); }
              2% {
                opacity: 1;
                transform: translateY(1vh) translateX(1px);
              }
              3% { transform: translateY(2vh) translateX(-0.5px); }
              15% {
                transform: translateY(15vh) translateX(0.5px);
              }
              15.2% {
                transform: translateY(12vh) translateX(-2px);
                filter: brightness(1.5);
              }
              15.4% {
                transform: translateY(16vh) translateX(2px);
              }
              15.6% {
                transform: translateY(14vh) translateX(-1px);
                filter: brightness(1.2);
              }
              15.8% {
                transform: translateY(15vh) translateX(0);
                filter: brightness(1);
              }
              35% {
                transform: translateY(35vh) translateX(-0.5px);
              }
              35.15% {
                transform: translateY(38vh) translateX(2px);
                filter: brightness(1.8);
              }
              35.3% {
                transform: translateY(33vh) translateX(-2px);
              }
              35.45% {
                transform: translateY(37vh) translateX(1px);
                filter: brightness(1.3);
              }
              35.6% {
                transform: translateY(35vh) translateX(0);
                filter: brightness(1);
              }
              60% {
                transform: translateY(60vh) translateX(0.5px);
              }
              60.1% {
                transform: translateY(56vh) translateX(-2px);
                filter: brightness(2);
              }
              60.2% {
                transform: translateY(62vh) translateX(2px);
              }
              60.3% {
                transform: translateY(58vh) translateX(-1px);
                filter: brightness(1.5);
              }
              60.4% {
                transform: translateY(61vh) translateX(1px);
              }
              60.5% {
                transform: translateY(60vh) translateX(0);
                filter: brightness(1);
              }
              85% {
                transform: translateY(85vh) translateX(-0.5px);
              }
              85.1% {
                transform: translateY(82vh) translateX(2px);
                filter: brightness(1.7);
              }
              85.2% {
                transform: translateY(87vh) translateX(-2px);
              }
              85.3% {
                transform: translateY(83vh) translateX(1px);
                filter: brightness(2);
              }
              85.4% {
                transform: translateY(86vh) translateX(-1px);
              }
              85.5% {
                transform: translateY(84vh) translateX(1px);
              }
              85.6% {
                transform: translateY(85vh) translateX(0);
                filter: brightness(1);
              }
              97% { transform: translateY(97vh) translateX(-1px); }
              98% {
                opacity: 1;
                transform: translateY(98vh) translateX(1px);
              }
              100% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
              }
            }
          `;
          document.head.appendChild(style);
        }

        const scanline = document.createElement('div');
        scanline.className = 'user-card__scanline';
        scanline.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          width: 100%;
          height: 2px;
          background: linear-gradient(to bottom, transparent, rgba(212, 175, 55, 0.4), transparent);
          box-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
          pointer-events: none;
          animation: scanline-anim 8s linear infinite;
          z-index: 999;
          will-change: transform;
        `;
        root.appendChild(scanline);
        console.log('Scanline appended with animation');
      } else {
        console.log('Scanline already exists:', existingScanline);
      }
    }

    // Init on page load
    console.log('Script loaded');
    initUserCard();

    // Re-init after view transitions
    document.addEventListener('astro:page-load', () => {
      console.log('astro:page-load event fired');
      initUserCard();
    });
  </script>
</section>
