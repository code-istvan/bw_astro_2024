---
import { Image } from 'astro:assets';
import './UserCard.scss';
import { formatDate } from '../../ts/utils';

type UserRow = Record<string, any>;

interface Props {
  user: UserRow;
  lang?: 'hu' | 'en';
}

const { user, lang = 'hu' } = Astro.props;

// Avatar: csak akkor próbáljuk az Astro Image optimalizálást,
// ha local path ("/images/...") – a te eddigi logikád szerint.
const avatarPath = typeof user?.avatar_url === 'string' && user.avatar_url.startsWith('/') ? user.avatar_url : null;

// Név – (Hero már nem user-specifikus, itt jelenik meg a teljes név)
const fullName = `${user?.family_name ?? ''} ${user?.first_name ?? ''}`.trim();

// Az "utolsó ászana" felirat, ahogy kérted
const lastAsanaLabel = 'Utolsó ászana:';
---

<section class="user-card" aria-label="User profile">
  <div class="user-card__header">
    {
      avatarPath && (
        <div class="user-card__avatar">
          <Image
            src={avatarPath}
            alt={fullName || 'User avatar'}
            width={96}
            height={96}
            class="avatar__image avatar__image--medium user-card__avatar-img"
            loading="lazy"
            decoding="async"
          />
        </div>
      )
    }

    <div class="user-card__identity">
      <h2 class="user-card__name">{fullName || 'User'}</h2>
      {user?.role && <p class="user-card__role">{user.role}</p>}
    </div>

    <div class="user-card__status">
      <span class="user-card__status-label">STATUS</span>
      <span class="user-card__status-value">
        {user?.pass_type === 'monthly' ? 'ACTIVE' : 'LIMITED'}
      </span>
    </div>
  </div>

  <div class="user-card__grid">
    {
      user?.birthday && (
        <>
          <div class="user-card__label">Születési dátum</div>
          <div class="user-card__value">{formatDate(user.birthday, lang)}</div>
        </>
      )
    }

    {
      user?.phone_number && (
        <>
          <div class="user-card__label">Telefon</div>
          <div class="user-card__value">{user.phone_number}</div>
        </>
      )
    }

    {
      user?.email && (
        <>
          <div class="user-card__label">Email</div>
          <div class="user-card__value">{user.email}</div>
        </>
      )
    }
  </div>

  {
    user?.last_asana && (
      <div class="user-card__highlight">
        <div class="user-card__highlight-label">{lastAsanaLabel}</div>
        <div class="user-card__highlight-value">{user.last_asana}</div>
      </div>
    )
  }

  <div class="user-card__access">
    <div class="user-card__access-title">ACCESS</div>

    {
      user?.pass_type === 'monthly' ? (
        <div class="user-card__access-body">
          <div class="user-card__access-row">
            <span class="user-card__label-inline">Bérlet</span>
            <span class="user-card__value-inline">Havi</span>
          </div>

          {user?.assigned_at && (
            <div class="user-card__access-row">
              <span class="user-card__label-inline">Vásárlás</span>
              <span class="user-card__value-inline">{formatDate(user.assigned_at, lang)}</span>
            </div>
          )}

          {user?.expires_at && (
            <div class="user-card__access-row">
              <span class="user-card__label-inline">Érvényes eddig</span>
              <span class="user-card__value-inline">{formatDate(user.expires_at, lang)}</span>
            </div>
          )}
        </div>
      ) : (
        <div class="user-card__access-body">
          <p class="user-card__muted">Nincs aktív havi bérlet.</p>
        </div>
      )
    }
  </div>

  <div class="user-card__actions">
    <button class="user-card__logout" id="logout_button" type="button">LOG OUT</button>
  </div>

  <script>
    import { actions } from 'astro:actions';
    import { navigate } from 'astro:transitions/client';

    document.getElementById('logout_button')?.addEventListener('click', async () => {
      const { error } = await actions.logout(new FormData());
      if (!error) navigate('/login');
    });
  </script>
</section>
