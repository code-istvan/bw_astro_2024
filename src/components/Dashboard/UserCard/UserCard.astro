---
import { Image } from 'astro:assets';
import { formatDate, formatPhoneNumber } from '../../ts/utils';
import './UserCard.scss';

type UserRow = Record<string, any>;

interface Props {
  user: UserRow;
  lang?: 'hu' | 'en';
}

const { user, lang = 'hu' } = Astro.props;
const avatarPath = typeof user?.avatar_url === 'string' && user.avatar_url.startsWith('/') ? user.avatar_url : null;
const fullName = `${user?.family_name ?? ''} ${user?.first_name ?? ''}`.trim();
const isMonthly = user?.pass_type === 'monthly';
const statusText = isMonthly ? 'ACTIVE' : 'LIMITED';

// Role fordítás
const roleTranslations: Record<string, string> = {
  practitioner: 'GYAKORLÓ',
  admin: 'ADMINISZTRÁTOR',
};

const translatedRole = user?.role ? roleTranslations[user.role.toLowerCase()] || user.role.toUpperCase() : null;
---

<section class="user-card" aria-label="User profile" data-user-card>
  <div class="user-card__profile-section">
    {
      avatarPath && (
        <div class="user-card__avatar-container">
          <Image
            src={avatarPath}
            alt={fullName || 'User avatar'}
            width={140}
            height={140}
            class="user-card__avatar effect-glitch"
            loading="lazy"
            decoding="async"
          />
        </div>
      )
    }

    <div class="user-card__profile-info">
      <div class="user-card__label">‹ NÉV :</div>
      <h2 class="user-card__name">{fullName || 'User'}</h2>
      {translatedRole && <div class="user-card__role">‹ {translatedRole} ›</div>}
    </div>

    <div class="user-card__status">
      <span class="user-card__status-dot effect-pulse"></span>
      <span class="user-card__status-text">{statusText}</span>
    </div>
  </div>

  <div class="user-card__info-grid">
    <div class="user-card__info-title">| SZEMÉLYES ADATOK |</div>

    {
      user?.birthday && (
        <div class="user-card__info-row">
          <span class="user-card__info-label">‹ SZÜLETÉSI DÁTUM :</span>
          <span class="user-card__info-value">{formatDate(user.birthday, lang)}</span>
        </div>
      )
    }

    {
      user?.phone_number && (
        <div class="user-card__info-row">
          <span class="user-card__info-label">‹ TELEFON :</span>
          <span class="user-card__info-value">{formatPhoneNumber(user.phone_number)}</span>
        </div>
      )
    }

    {
      user?.email && (
        <div class="user-card__info-row">
          <span class="user-card__info-label">‹ EMAIL :</span>
          <span class="user-card__info-value">{user.email}</span>
        </div>
      )
    }
  </div>

  {
    user?.last_asana && (
      <div class="user-card__asana-section">
        <div class="user-card__asana-label">‹ UTOLSÓ ÁSZANÁD :</div>
        <div class="user-card__asana-text">{user.last_asana}</div>
      </div>
    )
  }

  <div class="user-card__access-section">
    <div class="user-card__access-title">| TAGSÁGI STÁTUSZ |</div>

    {
      isMonthly ? (
        <div class="user-card__access-body">
          <div class="user-card__info-row">
            <span class="user-card__info-label">‹ BÉRLET:</span>
            <span class="user-card__info-value effect-text-glitch">HAVI</span>
          </div>

          {user?.assigned_at && (
            <div class="user-card__info-row">
              <span class="user-card__info-label">‹ VÁSÁRLÁS:</span>
              <span class="user-card__info-value effect-text-glitch">{formatDate(user.assigned_at, lang)}</span>
            </div>
          )}

          {user?.expires_at && (
            <div class="user-card__info-row">
              <span class="user-card__info-label">‹ ÉRVÉNYES:</span>
              <span class="user-card__info-value effect-text-glitch">{formatDate(user.expires_at, lang)}</span>
            </div>
          )}
        </div>
      ) : (
        <div class="user-card__access-body">
          <p class="user-card__muted">Nincs aktív havi bérlet.</p>
        </div>
      )
    }
  </div>

  <div class="user-card__actions">
    <button class="user-card__logout" type="button" data-logout>
      <span class="btn-text">KILÉPÉS</span>
      <span class="btn-loader">
        <span class="loader-dot"></span>
        <span class="loader-dot"></span>
        <span class="loader-dot"></span>
      </span>
    </button>
  </div>

  <script>
    import { actions } from 'astro:actions';
    import { navigate } from 'astro:transitions/client';

    function initUserCard() {
      const root = document.querySelector('[data-user-card]');

      if (!root) return;

      const logoutButton = root.querySelector('[data-logout]') as HTMLButtonElement;

      // Cleanup: reset button state on page load
      if (logoutButton) {
        logoutButton.classList.remove('btn-loading');
        logoutButton.disabled = false;
      }

      logoutButton?.addEventListener('click', async () => {
        // Loading effect aktiválása
        logoutButton.classList.add('btn-loading');
        logoutButton.disabled = true;

        const { error } = await actions.logout(new FormData());

        if (!error) {
          // Wait for navigate to finish, then replace the history entry
          navigate('/login');
          // Use requestAnimationFrame to wait for the navigation to complete
          requestAnimationFrame(() => {
            window.history.replaceState(null, '', '/login');
          });
        } else {
          // Hiba esetén loading effect leállítása
          logoutButton.classList.remove('btn-loading');
          logoutButton.disabled = false;
        }
      });

      // Scanline effect
      const existingScanline = root.querySelector('.user-card__scanline');
      if (!existingScanline) {
        if (!document.getElementById('scanline-keyframes')) {
          const style = document.createElement('style');
          style.id = 'scanline-keyframes';
          style.textContent = `
              @keyframes scanline-anim {
                0% { top: -2px; opacity: 0; }
                1% { top: 0%; transform: translateX(-1px); }
                2% { opacity: 1; top: 2%; transform: translateX(1px); }
                3% { top: 3%; transform: translateX(-0.5px); }
                15% { top: 15%; transform: translateX(0.5px); }
                15.2% { top: 12%; transform: translateX(-2px); filter: brightness(1.5); }
                15.4% { top: 16%; transform: translateX(2px); }
                15.6% { top: 14%; transform: translateX(-1px); filter: brightness(1.2); }
                15.8% { top: 15%; transform: translateX(0); filter: brightness(1); }
                35% { top: 35%; transform: translateX(-0.5px); }
                35.15% { top: 38%; transform: translateX(2px); filter: brightness(1.8); }
                35.3% { top: 33%; transform: translateX(-2px); }
                35.45% { top: 37%; transform: translateX(1px); filter: brightness(1.3); }
                35.6% { top: 35%; transform: translateX(0); filter: brightness(1); }
                60% { top: 60%; transform: translateX(0.5px); }
                60.1% { top: 56%; transform: translateX(-2px); filter: brightness(2); }
                60.2% { top: 62%; transform: translateX(2px); }
                60.3% { top: 58%; transform: translateX(-1px); filter: brightness(1.5); }
                60.4% { top: 61%; transform: translateX(1px); }
                60.5% { top: 60%; transform: translateX(0); filter: brightness(1); }
                85% { top: 85%; transform: translateX(-0.5px); }
                85.1% { top: 82%; transform: translateX(2px); filter: brightness(1.7); }
                85.2% { top: 87%; transform: translateX(-2px); }
                85.3% { top: 83%; transform: translateX(1px); filter: brightness(2); }
                85.4% { top: 86%; transform: translateX(-1px); }
                85.5% { top: 84%; transform: translateX(1px); }
                85.6% { top: 85%; transform: translateX(0); filter: brightness(1); }
                97% { top: 97%; transform: translateX(-1px); }
                98% { opacity: 1; top: 98%; transform: translateX(1px); }
                100% { top: 100%; transform: translateX(0); opacity: 0; }
              }
            `;
          document.head.appendChild(style);
        }

        const scanline = document.createElement('div');
        scanline.className = 'user-card__scanline';
        scanline.style.cssText = `
            position: absolute;
            left: 0;
            right: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to bottom, transparent, rgba(212, 175, 55, 0.4), transparent);
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
            pointer-events: none;
            animation: scanline-anim 8s linear infinite;
            z-index: 999;
          `;
        root.appendChild(scanline);
      }
    }

    initUserCard();
    document.addEventListener('astro:page-load', initUserCard);
  </script>
</section>
