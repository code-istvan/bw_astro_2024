---
import './_typewriter.scss';

const {
    textArray = [],
    id: propId,
    align = 'left',
    loopAll = false, // az egész oldal Typewriter-sorozata ismétlődjön?
    loopAllDelay = 1000, // szünet a körök között (ms)
    cursorColor = 'white', // ÚJ: 'white' | 'orange'
} = Astro.props;

// Egyedi azonosító minden példánynak
const uid = propId ?? `tw-${crypto.randomUUID?.() ?? Math.random().toString(36).slice(2)}`;
---

<div class="typewriter-wrap">
    <div
        class={`output ${align === 'center' ? 'align-center' : 'align-left'} ${cursorColor === 'orange' ? 'cursor-orange' : 'cursor-white'}`}
        id={`output-${uid}`}
        data-tw-id={uid}
    >
        <p></p>
    </div>
</div>

<script type="module" is:inline define:vars={{ textArray, uid, loopAll, loopAllDelay }}>
    // Globális vezérlő a sorba rendezéshez és a teljes kör ismétléséhez
    const TW = (function () {
        const g = typeof window !== 'undefined' ? window : {};
        g.__twQueue = g.__twQueue || []; // aktuális kör feladatai
        g.__twStarters = g.__twStarters || []; // fix sorrend a kör újraindításához
        g.__twRunning = g.__twRunning || false;
        g.__twLoopAll = g.__twLoopAll ?? false;
        g.__twLoopAllDelay = g.__twLoopAllDelay ?? 1000;

        function setLoopAll(val, delay) {
            g.__twLoopAll = !!val;
            if (typeof delay === 'number') g.__twLoopAllDelay = delay;
        }

        function runNext() {
            if (g.__twQueue.length > 0) {
                const fn = g.__twQueue.shift();
                fn();
            } else {
                // Kör vége
                if (g.__twLoopAll && g.__twStarters.length > 0) {
                    setTimeout(() => {
                        g.__twQueue.push(...g.__twStarters.map((fn) => fn));
                        runNext();
                    }, g.__twLoopAllDelay);
                } else {
                    g.__twRunning = false;
                }
            }
        }

        function enqueue(fn) {
            g.__twQueue.push(fn);
            if (!g.__twRunning) {
                g.__twRunning = true;
                runNext();
            }
        }

        function registerStarter(fn) {
            g.__twStarters.push(fn);
        }
        function done() {
            runNext();
        }

        return { enqueue, registerStarter, done, setLoopAll };
    })();

    window.addEventListener('DOMContentLoaded', () => {
        const output = document.getElementById(`output-${uid}`);
        if (!output || !Array.isArray(textArray) || textArray.length === 0) return;

        const eParagraph = output.querySelector('p');

        // tempók
        const speedForward = 100; // gépelés
        const speedWait = 1000; // vár, mielőtt töröl
        const speedBackspace = 25; // törlés
        const blinkPeriod = 500; // 0.5s: a CSS blink periódusa

        if (typeof TW.setLoopAll === 'function') {
            TW.setLoopAll(loopAll, loopAllDelay);
        }

        // Egy példány futtatója
        const starter = () => {
            let i = 0,
                a = 0,
                isBackspacing = false;

            function typeWriter() {
                const aString = textArray[a];

                if (!isBackspacing) {
                    // üzenet vége → vár, majd töröl
                    if (i >= aString.length) {
                        isBackspacing = true;
                        setTimeout(typeWriter, speedWait);
                        return;
                    }

                    const ch = aString.charAt(i);

                    // '|' → gondolkodó szünet (több '|' → hosszabb)
                    if (ch === '|') {
                        let pipes = 0;
                        while (aString.charAt(i + pipes) === '|') pipes++;
                        i += pipes; // nem írjuk ki a '|' jeleket
                        if (!eParagraph.classList.contains('cursor')) eParagraph.classList.add('cursor');
                        setTimeout(typeWriter, pipes * blinkPeriod);
                        return;
                    }

                    // normál karakter
                    eParagraph.textContent += ch;
                    i++;
                    setTimeout(typeWriter, speedForward);
                } else {
                    // törlés fázis
                    if (eParagraph.textContent.length > 0) {
                        eParagraph.textContent = eParagraph.textContent.slice(0, -1);
                        setTimeout(typeWriter, speedBackspace);
                    } else {
                        // következő üzenet ugyanebben a példányban
                        isBackspacing = false;
                        i = 0;
                        a = (a + 1) % textArray.length;

                        // visszaértünk az elejére → példány kész
                        if (a === 0) {
                            eParagraph.classList.remove('cursor'); // kurzor le
                            TW.done(); // jöhet a következő példány
                            return;
                        }
                        setTimeout(typeWriter, 50);
                    }
                }
            }

            // indulás: tiszta tartalom + kurzor fel
            eParagraph.textContent = '';
            eParagraph.classList.add('cursor');
            setTimeout(typeWriter, 300);
        };

        // regisztráljuk a kört és indítjuk
        TW.registerStarter(starter);
        TW.enqueue(starter);
    });
</script>
