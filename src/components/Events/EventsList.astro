---
import { getCollection } from 'astro:content';
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';
// import teachersData from '../../data/teachers.json';

const { eventType = [], maxEvents = Infinity } = Astro.props;

const events = await getCollection('events');

const images = await import.meta.glob<{ default: ImageMetadata }>('/src/images/uploads/**/*.{jpeg,jpg,png,gif}');

// Dátum formázó függvény a magyar formátumhoz, pontok nélkül
function formatDate(date: string | Date): string {
    const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'short', day: 'numeric' };
    const formattedDate = new Intl.DateTimeFormat('hu-HU', options).format(new Date(date)).toUpperCase();
    return formattedDate.replace(/\./g, ''); // Pontok eltávolítása
}

const upcomingEvents = events
    .filter((event) => event.data.published) // Csak a publikált eseményeket jelenítjük meg
    .filter((event) => new Date(event.data.date) >= new Date()) // Múltbéli események kiszűrése
    .filter((event) => eventType.length === 0 || eventType.includes(event.data.eventType)) // Szűrés az eventTypes alapján
    .sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime()) // Rendezés dátum szerint
    .slice(0, maxEvents); // Csak a megadott számú eseményt jelenítjük meg

// Tanárok adatainak feltérképezése teacherId alapján
// type Teacher = {
//     teacherId: string;
//     teacherName: string;
//     teacherLink: string;
//     teacherImage?: string;
// };

// const teacherMap = new Map<string, Teacher>(
//     teachersData.teachers.map((teacher: Teacher) => [teacher.teacherId, teacher])
// );
---

<div class="mt-40px">
    {
        upcomingEvents.map(
            (event: {
                id: string;
                collection: string;
                data: {
                    published?: boolean;
                    title?: string;
                    titleEnglish?: string;
                    date?: Date;
                    teacher?: string;
                    featured?: boolean;
                    eventTypes?: string;
                    eventid?: string;
                    eventimage?: string;
                    shortdescription?: string;
                    shortdescriptionEnglish?: string;
                    eventlink?: string;
                    eventlinkEnglish?: string;
                };
            }) => (
                <>
                    <div class="row mb-40px">
                        <div class="event-card">
                            <div class="event-card__image">
                                {' '}
                                {event.data.eventimage && (
                                    <Image src={images[`/${event.data.eventimage}`]()} alt={event.data.title} />
                                )}
                            </div>
                            <div class="event-card__details">
                                <div class="event-card__date-container">
                                    <span>
                                        <h2>{new Date(event.data.date).getFullYear()}</h2>
                                    </span>
                                    <span>
                                        <h2>
                                            {new Date(event.data.date)
                                                .toLocaleString('hu-HU', { month: 'short' })
                                                .replace('.', '')
                                                .toUpperCase()}
                                        </h2>
                                    </span>
                                    <span>
                                        <h2>{new Date(event.data.date).getDate()}</h2>
                                    </span>
                                </div>
                                <div class="event-card__section--hidden-desktop">
                                    <h2 class="text-uppercase">{event.data.title}</h2>
                                    <a
                                        href={event.data.eventlink}
                                        class="clr-brand-orange mt-40px"
                                        aria-label="Tudj meg többet rólunk gomb"
                                    >
                                        <p>
                                            <strong>Részletek</strong>
                                        </p>
                                    </a>
                                </div>
                            </div>
                            <div class="event-card__description event-card__section--hidden-mobile">
                                <h2 class="text-uppercase">{event.data.title}</h2>
                                <a
                                    href={event.data.eventlink}
                                    class="clr-brand-orange mt-40px"
                                    aria-label="Tudj meg többet rólunk gomb"
                                >
                                    <p>
                                        <strong>Részletek</strong>
                                    </p>
                                </a>
                            </div>
                            <div class="event-card__actions">
                                {' '}
                                <a
                                    href={event.data.eventlink}
                                    class="btn btn--full-width-mobile btn--primary--outline mt-20px"
                                    aria-label="Tudj meg többet rólunk gomb"
                                >
                                    Jelentkezés
                                </a>
                            </div>
                        </div>
                        <div class="separator-horizontal event-card__section--hidden-mobile mt-40px" />
                    </div>
                </>
            )
        )
    }
</div>

<style>
    .event-card {
        margin: 0;
        display: grid;
        height: auto;
        max-width: 100%;
        grid-template-areas:
            'A B'
            'A C'
            'D D';
        grid-template-columns: auto 1fr;
        grid-template-rows: auto auto auto; /* Itt az 'auto' meghatározza a magasságot a tartalom alapján */
        gap: 20px;

        .btn {
            margin-top: 0;
        }
        img {
            width: 200px;
            height: auto;
        }
    }
    .event-card__image {
        grid-area: A;
    }
    .event-card__details {
        grid-area: B;
        text-align: left;
        height: auto;
        align-self: start;
    }
    .event-card__description {
        grid-area: C;
        text-align: left;
        height: max-content;
    }
    .event-card__actions {
        grid-area: D;
    }

    .event-card__date-container {
        display: flex;
        flex-direction: row; /* Alapértelmezett beállítás, 1080px alatt */
        gap: 5px;
    }

    .event-card__section--hidden-desktop {
        display: block;
    }

    .event-card__section--hidden-mobile {
        display: none;
    }

    @media (min-width: 1081px) {
        .event-card {
            grid-template-areas: 'B A C D';
            grid-template-columns: auto auto minmax(450px, 1fr) 1fr;
            grid-template-rows: auto; /* Az auto itt is alkalmazkodik a tartalom magasságához */
            align-items: start;
        }

        .event-card__section--hidden-desktop {
            display: none;
        }

        .event-card__section--hidden-mobile {
            display: block;
        }
        .event-card__image {
            text-align: left;
        }

        .event-card__details .event-card__date-container {
            flex-direction: column;
            align-items: flex-start;
        }
        .event-card__actions {
            text-align: right;
            .btn {
                margin-top: 0;
                margin-left: auto;
            }
        }
    }
</style>
