---
import Matrix from '../components/Matrix/Matrix.astro';
import LoginLayout from '../layouts/LoginLayout.astro';
import Input from '../components/Forms/Input/Input.astro';
import IconButton from '../components/Button/IconButton.astro';
import { actions } from 'astro:actions';
import '../sass/pages/_login.scss';

const metadata = {
  title: 'LOGIN',
  description: 'Ezen az oldalon tudsz bejelentkezni az egyedi felhasználói fiókodba.',
};

const token = await Astro.session?.get('user-session');
if (token) {
  return Astro.redirect('/dashboard');
}
---

<LoginLayout title={metadata.title} description={metadata.description}>
  <div class="login-root">
    <Matrix style="matrix" color="color-one" />

    <!-- Hyperspace Jump Effect -->
    <div id="hyperspace-overlay" class="hyperspace-overlay">
      <div class="hyperspace-container" id="hyperspace-container">
        <!-- Csillagok dinamikusan generálódnak JS-ből -->
      </div>
    </div>

    <div class="dialog-overlay container">
      <dialog class="login-dialog" open>
        <h3 class="align-left">The Only Way Out is logIN</h3>
        <p class="mb-20px align-left clr-shades-gray">Please log in to your account to continue.</p>

        <div class="input-wrapper">
          <form id="login-form" class="login-form" method="post" action={actions.login}>
            <div class="row gap-1rem">
              <div class="col-12-xs">
                <Input id="identifier" name="identifier" type="text" placeholder="Username" />
              </div>
              <div class="col-12-xs">
                <Input id="password" name="password" type="password" placeholder="Password" />
              </div>
              <div class="col-12-xs">
                <p class="clr-red"></p>
              </div>
              <div class="col-12-xs">
                <button type="submit" id="login-button" class="btn btn--primary--solid btn--width-full">
                  <span class="btn-text">LogIN</span>
                  <span class="btn-loader">
                    <span class="loader-dot"></span>
                    <span class="loader-dot"></span>
                    <span class="loader-dot"></span>
                  </span>
                </button>
              </div>
              <IconButton
                href="/"
                variant="btn--third--naked-gray"
                iconName="ArrowLeft"
                iconColor="lightGray"
                class="no-padding mt-20px back-button"
                ariaLabel="Vissza a főoldalra gomb"
                hoverEffect="iconColor"
                hoverIconColor="orange"
              >
                Back to homepage
              </IconButton>
            </div>
          </form>
        </div>
      </dialog>
    </div>
  </div>
</LoginLayout>

<script>
  import { actions } from 'astro:actions';
  import { navigate } from 'astro:transitions/client';

  const form = document.querySelector('#login-form') as HTMLFormElement;
  const button = document.querySelector('#login-button') as HTMLButtonElement;
  const hyperspaceOverlay = document.querySelector('#hyperspace-overlay') as HTMLElement;
  const hyperspaceContainer = document.querySelector('#hyperspace-container') as HTMLElement;

  // Hipersebességi csillagok generálása
  function generateHyperspaceStars() {
    const starCount = 80; // Csillagok száma

    for (let i = 0; i < starCount; i++) {
      const star = document.createElement('div');
      star.className = 'star-line';

      // Random szög (körben minden irányba)
      const angle = Math.random() * 360;

      // Random késleltetés (0-300ms)
      const delay = Math.random() * 0.3;

      star.style.transform = `rotate(${angle}deg)`;
      star.style.animationDelay = `${delay}s`;

      hyperspaceContainer.appendChild(star);
    }
  }

  // Csillagok generálása egyszer az oldal betöltésekor
  generateHyperspaceStars();

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Gomb loading state aktiválása
    button.classList.add('btn-loading');
    button.disabled = true;

    const formData = new FormData(form);
    const identifier = formData.get('identifier');
    const password = formData.get('password');

    const userData = new FormData();
    userData.append('identifier', identifier as string);
    userData.append('password', password as string);

    const { data, error } = await actions.login(userData);

    if (error) {
      // Hiba esetén leállítjuk a loadingot
      button.classList.remove('btn-loading');
      button.disabled = false;
      document.querySelector('.clr-red')!.textContent = error.message;
    } else {
      // Sikeres login esetén hipersebességi ugrás!
      hyperspaceOverlay.classList.add('active');

      // Admin vagy user redirect
      setTimeout(() => {
        const redirectUrl = (data as any).redirectTo || '/dashboard';
        navigate(redirectUrl);
      }, 1800);
    }
  });
</script>
