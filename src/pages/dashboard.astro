---
import BaseLayout from '../layouts/BaseLayout.astro';
import HeroImage from '../components/HeroImage/HeroImage.astro';
import { turso } from '../turso';
import UserCard from '../components/Dashboard/UserCard/UserCard.astro';
import mobileImage from '../images/zion_mobil.jpeg';
import desktopImage from '../images/zion_desktop.jpeg';
export const prerender = false;
/* ---------------------------------
   Base metadata (fallback)
---------------------------------- */
const metadata = {
  title: 'Dashboard',
  description: 'Your personal dashboard at Bandha Works Yoga Shala.',
};
const HERO_TITLE = 'The Source';
/* ---------------------------------
   Auth guard
---------------------------------- */
const token = await Astro.session?.get('user-session');
if (!token) return Astro.redirect('/');
/* ---------------------------------
   Load user + active monthly pass
---------------------------------- */
const { rows } = await turso.execute({
  sql: `
    SELECT
      u.first_name,
      u.family_name,
      u.email,
      u.alias,
      u.phone_number,
      u.last_asana,
      u.role,
      u.birthday,
      u.avatar_url,
      p.pass_type,
      up.assigned_at,
      up.expires_at
    FROM users u
    LEFT JOIN user_passes up
      ON u.id = up.user_id
    LEFT JOIN passes p
      ON up.pass_id = p.id
    WHERE u.id = ?
      AND (
        up.id IS NULL
        OR up.expires_at IS NULL
        OR date(up.expires_at) >= date('now')
      )
    LIMIT 1
  `,
  args: [token],
});

const user = rows[0] ?? null;
if (!user) return Astro.redirect('/');
const pageTitle = user.family_name && user.first_name ? `${user.family_name} ${user.first_name}` : metadata.title;
---

<BaseLayout title={pageTitle} description={metadata.description} image={desktopImage}>
  <HeroImage
    mobileImgUrl={mobileImage}
    desktopImgUrl={desktopImage}
    alt={HERO_TITLE}
    pageName={HERO_TITLE}
    containerClass="container--tight-desktop"
  />
  <div class="container container--tight-desktop dashboard-content">
    <UserCard user={user} lang="hu" />
  </div>
</BaseLayout>
