---
import BaseLayout from '../layouts/BaseLayout.astro';
import HeroImage from '../components/HeroImage/HeroImage.astro';
import { Image } from 'astro:assets';
import { turso } from '../turso';
import UserCard from '../components/Dashboard/UserCard/UserCard.astro';
import mobileImage from '../images/zion_mobil.jpeg';
import desktopImage from '../images/zion_desktop.jpeg';

export const prerender = false;

/* ---------------------------------
   Base metadata (fallback)
---------------------------------- */
const metadata = {
  title: 'Dashboard',
  description: 'Your personal dashboard at Bandha Works Yoga Shala.',
};

const HERO_TITLE = 'The Mula Gate';

/* ---------------------------------
   Auth guard
---------------------------------- */
const token = await Astro.session?.get('user-session');
if (!token) return Astro.redirect('/login');

/* ---------------------------------
   Load user + active monthly pass
---------------------------------- */
const { rows } = await turso.execute({
  sql: `
    SELECT
      u.first_name,
      u.family_name,
      u.email,
      u.alias,
      u.phone_number,
      u.last_asana,
      u.role,
      u.birthday,
      u.avatar_url,

      p.pass_type,
      up.assigned_at,
      up.expires_at

    FROM users u
    LEFT JOIN user_passes up ON u.id = up.user_id
    LEFT JOIN passes p
      ON up.pass_id = p.id
      AND p.pass_type = 'monthly'

    WHERE u.id = ?
    ORDER BY up.assigned_at IS NULL, up.assigned_at DESC
    LIMIT 1
  `,
  args: [token],
});

const user = rows[0] ?? null;
if (!user) return Astro.redirect('/login');

/* ---------------------------------
   Dynamic page title
---------------------------------- */
const pageTitle = user.family_name && user.first_name ? `${user.family_name} ${user.first_name}` : metadata.title;

/* ---------------------------------
   Helpers
---------------------------------- */
const avatarPath = typeof user.avatar_url === 'string' && user.avatar_url.startsWith('/') ? user.avatar_url : null;

const formatHuDate = (value) => {
  if (!value) return '';
  const d = new Date(String(value));
  if (Number.isNaN(d.getTime())) return String(value);
  return d.toLocaleDateString('hu-HU', { dateStyle: 'medium' });
};

/* ---------------------------------
   Dev logs
---------------------------------- */
if (import.meta.env.DEV) {
  console.log('Dashboard user:', user);
}
---

<BaseLayout title={pageTitle} description={metadata.description} image={desktopImage}>
  <HeroImage
    mobileImgUrl={mobileImage}
    desktopImgUrl={desktopImage}
    alt={HERO_TITLE}
    pageName={HERO_TITLE}
    containerClass="container--tight-desktop"
  />

  <div class="container container--tight-desktop">
    <div class="dashboard-content"><UserCard user={user} lang="hu" /></div>
  </div>

  <script>
    import { actions } from 'astro:actions';
    import { navigate } from 'astro:transitions/client';

    document.getElementById('logout_button')?.addEventListener('click', async () => {
      const { error } = await actions.logout(new FormData());
      if (!error) navigate('/login');
    });
  </script>
</BaseLayout>
