---
import BaseLayout from '../layouts/BaseLayout.astro';
import HeroImage from '../components/HeroImage/HeroImage.astro';
import mobileImage from '../images/elsoalkalom_mobil.jpg';
import desktopImage from '../images/elsoalkalom_desktop.jpg';
import firstTimeData from '../data/firstTime.json';
import { turso } from '../turso';

export const prerender = false;

const metadata = {
    title: 'ELSŐ ALKALOM',
    description:
        'Ezen az oldalon találod azokat az információkat, amelyek segítenek az első alkalommal való részvétel során.',
};

const token = await Astro.session?.get('user-session');

const huFirstTimeData = firstTimeData.HU;
if (!token) {
    return Astro.redirect('/login');
}

console.log('User token:', token);

const { rows } = await turso.execute({
    sql: `
        SELECT 
            u.*,
            p.id as pass_id,
            p.pass_type,
            p.expiration_date,
            p.uses_remaining,
            p.is_active as pass_is_active
        FROM users u
        LEFT JOIN user_passes up ON u.id = up.user_id
        LEFT JOIN passes p ON up.pass_id = p.id 
            AND p.is_active = 1 
            AND p.expiration_date > datetime('now')
        WHERE u.id = ?
        ORDER BY p.expiration_date DESC
        LIMIT 1
    `,
    args: [token],
});

console.log('rows:', rows);

const user = rows[0];

console.log('User:', user);
console.log('Pass ID:', user.pass_id);
console.log('Expiration:', user.expiration_date);
---

<BaseLayout title={metadata.title} description={metadata.description} image={desktopImage}>
    <HeroImage
        mobileImgUrl={mobileImage}
        desktopImgUrl={desktopImage}
        alt={metadata.title}
        pageName={metadata.title}
        containerClass="container--tight-desktop"
    />
    <div class="container container--tight-desktop">
        HELLO
        <h1>{user.fullname}</h1>
        {user.pass_yearly && <span>✅ Pass Anual</span>}
        {user.pass_membership && <span>✅ Membresía</span>}
        {user.pass_monthly && <span>✅ Pass Mensual</span>}
    </div>
</BaseLayout>
