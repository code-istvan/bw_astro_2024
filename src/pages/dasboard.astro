---
import BaseLayout from '../layouts/BaseLayout.astro';
import HeroImage from '../components/HeroImage/HeroImage.astro';
import mobileImage from '../images/zion_mobil.jpeg';
import desktopImage from '../images/zion_desktop.jpeg';
import { turso } from '../turso';
import { Image } from 'astro:assets';

export const prerender = false;

const metadata = {
  title: 'LOGIN OLDAL',
  description:
    'Ezen az oldalon találod azokat az információkat, amelyek segítenek az első alkalommal való részvétel során.',
};

const token = await Astro.session?.get('user-session');
if (!token) return Astro.redirect('/login');

const { rows } = await turso.execute({
  sql: `
    SELECT
      u.first_name,
      u.family_name,
      u.email,
      u.alias,
      u.phone_number,
      u.last_asana,
      u.role,
      u.birthday,
      u.avatar_url,

      p.id AS pass_id,
      p.pass_type,

      up.assigned_at,
      up.expires_at

    FROM users u
    LEFT JOIN user_passes up ON u.id = up.user_id
    LEFT JOIN passes p
      ON up.pass_id = p.id
      AND p.pass_type = 'monthly'

    WHERE u.id = ?
    ORDER BY up.assigned_at IS NULL, up.assigned_at DESC
    LIMIT 1
  `,
  args: [token],
});

const user = rows[0] ?? null;
if (!user) return Astro.redirect('/login');

if (import.meta.env.DEV) {
  console.log('User token:', token);
  console.log('user row:', user);
}

const avatarPath = typeof user.avatar_url === 'string' && user.avatar_url.startsWith('/') ? user.avatar_url : null;

const formatHuDate = (value) => {
  if (!value) return '';
  const d = new Date(String(value));
  if (Number.isNaN(d.getTime())) return String(value);
  return d.toLocaleDateString('hu-HU', { dateStyle: 'medium' });
};
---

<BaseLayout title={metadata.title} description={metadata.description} image={desktopImage}>
  <HeroImage
    mobileImgUrl={mobileImage}
    desktopImgUrl={desktopImage}
    alt={metadata.title}
    pageName={metadata.title}
    containerClass="container--tight-desktop"
  />

  <div class="container container--tight-desktop">
    <div>
      {
        avatarPath && (
          <Image
            src={avatarPath}
            alt={`${user.first_name ?? ''} ${user.family_name ?? ''}`.trim() || 'User avatar'}
            width={96}
            height={96}
            class="avatar__image avatar__image--medium"
            loading="lazy"
            decoding="async"
          />
        )
      }
    </div>

    <h1>{user.first_name}</h1>
    <h1>{user.family_name}</h1>

    {user.role && <p>{user.role}</p>}
    {user.birthday && <p>{user.birthday}</p>}
    {user.phone_number && <p>{user.phone_number}</p>}
    {user.last_asana && <p>{user.last_asana}</p>}

    {
      user.pass_type === 'monthly' && (
        <div>
          <p>Bérlet típusa: havi</p>
          <p>Vásárlás ideje: {formatHuDate(user.assigned_at)}</p>
          <p>Érvényes eddig: {formatHuDate(user.expires_at)}</p>
        </div>
      )
    }

    <button id="logout_button">LOG OUT</button>
  </div>

  <script>
    import { actions } from 'astro:actions';
    import { navigate } from 'astro:transitions/client';

    document.getElementById('logout_button')?.addEventListener('click', async () => {
      const { error } = await actions.logout(new FormData());
      if (!error) navigate('/login');
    });
  </script>
</BaseLayout>
