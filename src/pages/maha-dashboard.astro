---
import BaseLayout from '../layouts/BaseLayout.astro';
import { turso } from '../turso';
import HeroImage from '../components/HeroImage/HeroImage.astro';
import mobileImage from '../images/zion_mobil.jpeg';
import desktopImage from '../images/zion_desktop.jpeg';

export const prerender = false;

const metadata = {
  title: 'Maha Dashboard',
  description: 'Admin dashboard at Bandha Works Yoga Shala.',
};
const HERO_TITLE = 'Maha Dashboard';

/* ---------------------------------
   Auth guard
---------------------------------- */
const userId = await Astro.session?.get('user-session');

if (!userId) {
  return Astro.redirect('/');
}

const { rows } = await turso.execute({
  sql: 'SELECT role FROM users WHERE id = ?',
  args: [userId],
});

if (!rows[0] || rows[0].role !== 'admin') {
  return Astro.redirect('/dashboard/');
}

const user = rows[0];
---

<BaseLayout title="Admin Panel" description="Admin management panel">
  <HeroImage
    mobileImgUrl={mobileImage}
    desktopImgUrl={desktopImage}
    alt={HERO_TITLE}
    pageName={HERO_TITLE}
    containerClass="container--tight-desktop"
  />
  <div class="container">
    <h1>Welcome Admin!</h1>
    <p>You are logged in as: {user.role}</p>
    <div class="mb-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
      <p class="text-sm text-gray-600 dark:text-gray-400">
        <span class="font-semibold">Utols√≥ ment√©s:</span>
        <span id="last-backup-time" class="ml-2">-</span>
      </p>
    </div>
    <!-- Backup gomb -->
    <div class="admin-actions">
      <button id="backup-btn" type="button">üì¶ Adatb√°zis ment√©s let√∂lt√©se</button>

      <button id="logout-btn" type="button">üö™ Kil√©p√©s</button>
    </div>
  </div>

  <script is:inline>
    console.log('‚óè Inline script loaded');

    function setupButtons() {
      console.log('‚óè setupButtons called');

      const backupBtn = document.getElementById('backup-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const lastBackupTime = document.getElementById('last-backup-time');

      console.log('‚óè Backup button:', backupBtn);
      console.log('‚óè Logout button:', logoutBtn);

      // Load last backup time from localStorage
      if (lastBackupTime) {
        const savedTime = localStorage.getItem('lastBackupTime');
        if (savedTime) {
          lastBackupTime.textContent = savedTime;
        }
      }

      if (backupBtn) {
        console.log('‚óè Setting up backup button');
        backupBtn.addEventListener('click', async () => {
          console.log('‚óè BACKUP CLICKED!!!');

          // Visual feedback
          const originalText = backupBtn.textContent;
          backupBtn.disabled = true;
          backupBtn.textContent = 'Ment√©s folyamatban...';
          backupBtn.style.opacity = '0.6';

          try {
            const response = await fetch('/api/backup.json');
            const result = await response.json();
            console.log('‚óè Result:', result);

            if (result.success && result.githubCommit) {
              backupBtn.textContent = '‚úÖ Sikeres ment√©s!';
              backupBtn.style.backgroundColor = '#10b981';

              // Update and save last backup time
              if (lastBackupTime && result.timestamp) {
                lastBackupTime.textContent = result.timestamp;
                localStorage.setItem('lastBackupTime', result.timestamp);
              }
            } else {
              backupBtn.textContent = '‚ùå Hiba t√∂rt√©nt';
              backupBtn.style.backgroundColor = '#ef4444';
            }

            // Reset after 3 seconds
            setTimeout(() => {
              backupBtn.disabled = false;
              backupBtn.textContent = originalText;
              backupBtn.style.opacity = '1';
              backupBtn.style.backgroundColor = '';
            }, 3000);
          } catch (error) {
            console.error('‚óè Error:', error);
            backupBtn.textContent = '‚ùå Hiba t√∂rt√©nt';
            backupBtn.style.backgroundColor = '#ef4444';

            setTimeout(() => {
              backupBtn.disabled = false;
              backupBtn.textContent = originalText;
              backupBtn.style.opacity = '1';
              backupBtn.style.backgroundColor = '';
            }, 3000);
          }
        });
        console.log('‚úÖ Backup listener added');
      }

      if (logoutBtn) {
        console.log('‚óè Setting up logout button');
        logoutBtn.addEventListener('click', async () => {
          console.log('‚óè LOGOUT CLICKED!!!');
          try {
            await fetch('/api/auth/signout');
          } catch (e) {
            console.log('Signout error (ignoring):', e);
          }
          // Always redirect to homepage
          window.location.href = 'https://bandha.works';
        });
        console.log('‚úÖ Logout listener added');
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupButtons);
    } else {
      setupButtons();
    }

    console.log('‚óè Script finished');
  </script>

  <style>
    .admin-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .admin-actions button {
      padding: 1rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    #backup-btn {
      background: #4caf50;
      color: white;
    }

    #backup-btn:hover:not(:disabled) {
      background: #45a049;
    }

    #logout-btn {
      background: #f44336;
      color: white;
    }

    #logout-btn:hover:not(:disabled) {
      background: #da190b;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</BaseLayout>
