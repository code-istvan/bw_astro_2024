---
import BaseLayout from '../layouts/BaseLayout.astro';
import { turso } from '../turso';
import HeroImage from '../components/HeroImage/HeroImage.astro';
import mobileImage from '../images/zion_mobil.jpeg';
import desktopImage from '../images/zion_desktop.jpeg';

export const prerender = false;

const metadata = {
  title: 'Maha Dashboard',
  description: 'Admin dashboard at Bandha Works Yoga Shala.',
};
const HERO_TITLE = 'Maha Dashboard';

/* ---------------------------------
   Auth guard
---------------------------------- */
const userId = await Astro.session?.get('user-session');

if (!userId) {
  return Astro.redirect('/');
}

const { rows } = await turso.execute({
  sql: 'SELECT role FROM users WHERE id = ?',
  args: [userId],
});

if (!rows[0] || rows[0].role !== 'admin') {
  return Astro.redirect('/dashboard');
}

const user = rows[0];
---

<BaseLayout title="Admin Panel" description="Admin management panel">
  <HeroImage
    mobileImgUrl={mobileImage}
    desktopImgUrl={desktopImage}
    alt={HERO_TITLE}
    pageName={HERO_TITLE}
    containerClass="container--tight-desktop"
  />
  <div class="container">
    <h1>Welcome Admin!</h1>
    <p>You are logged in as: {user.role}</p>
  </div>
</BaseLayout>
