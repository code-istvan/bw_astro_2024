---
import BaseLayout from '../layouts/BaseLayout.astro';
import { turso } from '../turso';
import HeroImage from '../components/HeroImage/HeroImage.astro';
import mobileImage from '../images/zion_mobil.jpeg';
import desktopImage from '../images/zion_desktop.jpeg';

export const prerender = false;

const metadata = {
  title: 'Maha Dashboard',
  description: 'Admin dashboard at Bandha Works Yoga Shala.',
};
const HERO_TITLE = 'Maha Dashboard';

/* ---------------------------------
   Auth guard
---------------------------------- */
const userId = await Astro.session?.get('user-session');

if (!userId) {
  return Astro.redirect('/');
}

const { rows } = await turso.execute({
  sql: 'SELECT role FROM users WHERE id = ?',
  args: [userId],
});

if (!rows[0] || rows[0].role !== 'admin') {
  return Astro.redirect('/dashboard');
}

const user = rows[0];
---

<BaseLayout title="Admin Panel" description="Admin management panel">
  <HeroImage
    mobileImgUrl={mobileImage}
    desktopImgUrl={desktopImage}
    alt={HERO_TITLE}
    pageName={HERO_TITLE}
    containerClass="container--tight-desktop"
  />
  <div class="container">
    <h1>Welcome Admin!</h1>
    <p>You are logged in as: {user.role}</p>
    <!-- Backup gomb -->
    <div class="admin-actions">
      <button id="backup-btn" type="button">üì¶ Adatb√°zis ment√©s let√∂lt√©se</button>

      <button id="logout-btn" type="button">üö™ Kil√©p√©s</button>
    </div>
  </div>
  <script is:inline>
    console.log('üîç Inline script loaded');

    function setupButtons() {
      console.log('üîç setupButtons called');

      const backupBtn = document.getElementById('backup-btn');
      const logoutBtn = document.getElementById('logout-btn');

      console.log('üîç Backup button:', backupBtn);
      console.log('üîç Logout button:', logoutBtn);

      if (backupBtn) {
        console.log('üîç Setting up backup button');
        backupBtn.addEventListener('click', async function () {
          console.log('üîç BACKUP CLICKED!!!');

          try {
            backupBtn.textContent = '‚è≥ Ment√©s folyamatban...';
            backupBtn.disabled = true;

            const response = await fetch('/api/backup');
            const result = await response.json();

            console.log('üîç Result:', result);

            if (result.success) {
              backupBtn.textContent = '‚úÖ Sikeres!';
            } else {
              backupBtn.textContent = '‚ùå Hiba!';
            }

            setTimeout(() => {
              backupBtn.textContent = 'üì¶ Adatb√°zis ment√©s GitHub-ra';
              backupBtn.disabled = false;
            }, 2000);
          } catch (error) {
            console.error('Error:', error);
            backupBtn.textContent = '‚ùå Hiba!';
            backupBtn.disabled = false;
          }
        });

        console.log('‚úÖ Backup listener added');
      }

      if (logoutBtn) {
        console.log('üîç Setting up logout button');
        logoutBtn.addEventListener('click', async function () {
          console.log('üîç LOGOUT CLICKED!!!');
          window.location.href = '/';
        });

        console.log('‚úÖ Logout listener added');
      }
    }

    // Azonnal pr√≥b√°ljuk
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupButtons);
    } else {
      setupButtons();
    }

    console.log('üîç Script finished');
  </script>

  <style>
    .admin-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .admin-actions button {
      padding: 1rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    #backup-btn {
      background: #4caf50;
      color: white;
    }

    #backup-btn:hover:not(:disabled) {
      background: #45a049;
    }

    #logout-btn {
      background: #f44336;
      color: white;
    }

    #logout-btn:hover:not(:disabled) {
      background: #da190b;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</BaseLayout>
