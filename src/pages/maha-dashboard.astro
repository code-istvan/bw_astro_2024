---
import BaseLayout from '../layouts/BaseLayout.astro';
import { turso } from '../turso';
import HeroImage from '../components/HeroImage/HeroImage.astro';
import mobileImage from '../images/zion_mobil.jpeg';
import desktopImage from '../images/zion_desktop.jpeg';

export const prerender = false;

const metadata = {
  title: 'Maha Dashboard',
  description: 'Admin dashboard at Bandha Works Yoga Shala.',
};
const HERO_TITLE = 'Maha Dashboard';

/* ---------------------------------
   Auth guard
---------------------------------- */
const userId = await Astro.session?.get('user-session');

if (!userId) {
  return Astro.redirect('/');
}

const { rows } = await turso.execute({
  sql: 'SELECT role FROM users WHERE id = ?',
  args: [userId],
});

if (!rows[0] || rows[0].role !== 'admin') {
  return Astro.redirect('/dashboard');
}

const user = rows[0];
---

<BaseLayout title="Admin Panel" description="Admin management panel">
  <HeroImage
    mobileImgUrl={mobileImage}
    desktopImgUrl={desktopImage}
    alt={HERO_TITLE}
    pageName={HERO_TITLE}
    containerClass="container--tight-desktop"
  />
  <div class="container">
    <h1>Welcome Admin!</h1>
    <p>You are logged in as: {user.role}</p>
    <!-- Backup gomb -->
    <div class="admin-actions">
      <button id="backup-btn" type="button">ðŸ“¦ AdatbÃ¡zis mentÃ©s letÃ¶ltÃ©se</button>

      <button id="logout-btn" type="button">ðŸšª KilÃ©pÃ©s</button>
    </div>
  </div>

  <script>
    import { actions } from 'astro:actions';
    import { navigate } from 'astro:transitions/client';

    function initMahaDashboard() {
      console.log('ðŸ” initMahaDashboard called');

      const backupBtn = document.getElementById('backup-btn') as HTMLButtonElement;
      const logoutBtn = document.getElementById('logout-btn') as HTMLButtonElement;

      console.log('ðŸ” Buttons found:', !!backupBtn, !!logoutBtn);

      // Backup gomb
      if (backupBtn && !backupBtn.onclick) {
        console.log('ðŸ” Adding backup listener');

        backupBtn.addEventListener('click', async () => {
          console.log('ðŸ” Backup clicked!');
          try {
            backupBtn.textContent = 'â³ MentÃ©s folyamatban...';
            backupBtn.disabled = true;

            const response = await fetch('/api/backup');
            const result = await response.json();

            console.log('ðŸ” Backup result:', result);

            if (result.success) {
              backupBtn.textContent = 'âœ… MentÃ©s GitHub-ra sikeres!';
              setTimeout(() => {
                backupBtn.textContent = 'ðŸ“¦ AdatbÃ¡zis mentÃ©s GitHub-ra';
                backupBtn.disabled = false;
              }, 2000);
            } else {
              throw new Error('Backup failed');
            }
          } catch (error) {
            console.error('Backup error:', error);
            backupBtn.textContent = 'âŒ Hiba tÃ¶rtÃ©nt!';
            setTimeout(() => {
              backupBtn.textContent = 'ðŸ“¦ AdatbÃ¡zis mentÃ©s GitHub-ra';
              backupBtn.disabled = false;
            }, 2000);
          }
        });
      }

      // Logout gomb
      if (logoutBtn && !logoutBtn.onclick) {
        console.log('ðŸ” Adding logout listener');

        logoutBtn.addEventListener('click', async () => {
          console.log('ðŸ” Logout clicked!');
          try {
            logoutBtn.textContent = 'â³ MentÃ©s Ã©s kilÃ©pÃ©s...';
            logoutBtn.disabled = true;

            await fetch('/api/backup');
            await new Promise((resolve) => setTimeout(resolve, 500));

            const { error } = await actions.logout(new FormData());
            if (!error) {
              navigate('/');
            }
          } catch (error) {
            console.error('Logout error:', error);
            logoutBtn.textContent = 'ðŸšª KilÃ©pÃ©s';
            logoutBtn.disabled = false;
          }
        });
      }
    }

    // Azonnal fut
    initMahaDashboard();

    // View transitions esetÃ©n
    document.addEventListener('astro:page-load', initMahaDashboard);
  </script>

  <style>
    .admin-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .admin-actions button {
      padding: 1rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    #backup-btn {
      background: #4caf50;
      color: white;
    }

    #backup-btn:hover:not(:disabled) {
      background: #45a049;
    }

    #logout-btn {
      background: #f44336;
      color: white;
    }

    #logout-btn:hover:not(:disabled) {
      background: #da190b;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</BaseLayout>
